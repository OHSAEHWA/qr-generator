<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR ì½”ë“œ ìƒì„±ê¸° - ê³ ìƒ˜ì˜ì–´</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');

    :root {
      --primary: #778899;
      --primary-light: #8fa0b3;
      --primary-dark: #5a6d7f;
      --bg: #f4f6f8;
      --card-bg: #ffffff;
      --text: #2c3e50;
      --text-light: #7f8c8d;
      --border: #dfe6e9;
      --danger: #e74c3c;
      --danger-hover: #c0392b;
      --success: #27ae60;
      --success-hover: #219a52;
      --warning: #f39c12;
      --shadow: 0 2px 12px rgba(0,0,0,0.08);
      --shadow-hover: 0 4px 20px rgba(0,0,0,0.12);
      --radius: 10px;
      --font-size: 14px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: var(--font-size);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .header .subtitle {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 2px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .date-picker {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
    }

    .date-picker::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }

    /* Main Layout */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 20px;
    }

    /* Card */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-header h2 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .card-body {
      padding: 16px 18px;
    }

    /* Student List Panel */
    .student-panel {
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 120px);
      display: flex;
      flex-direction: column;
    }

    .student-add-row {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .student-add-row input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: inherit;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
    }

    .student-add-row input:focus {
      border-color: var(--primary);
    }

    .student-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .student-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      gap: 10px;
      margin-bottom: 2px;
    }

    .student-item:hover {
      background: #f0f3f6;
    }

    .student-item.selected {
      background: rgba(119, 136, 153, 0.12);
      border: 1px solid rgba(119, 136, 153, 0.3);
    }

    .student-item:not(.selected) {
      border: 1px solid transparent;
    }

    .student-checkbox {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }

    .student-item.selected .student-checkbox {
      background: var(--primary);
      border-color: var(--primary);
    }

    .student-checkbox svg {
      width: 12px;
      height: 12px;
      fill: none;
      stroke: white;
      stroke-width: 2.5;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .student-item.selected .student-checkbox svg {
      opacity: 1;
    }

    .student-name {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
    }

    .student-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .student-item:hover .student-actions {
      opacity: 1;
    }

    .icon-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
      color: var(--text-light);
    }

    .icon-btn:hover {
      background: #e8ecef;
    }

    .icon-btn.danger:hover {
      background: #fdecea;
      color: var(--danger);
    }

    .icon-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Buttons */
    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: var(--success-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      background: #f0f3f6;
    }

    /* Selected Students Work Area */
    .work-area {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .empty-state p {
      font-size: 14px;
    }

    .student-work-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card-bg);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .student-work-header {
      padding: 12px 18px;
      background: #f8f9fa;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .student-work-header h3 {
      font-size: 15px;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .qr-row {
      display: flex;
      align-items: center;
      padding: 14px 18px;
      border-bottom: 1px solid #f0f2f4;
      gap: 16px;
    }

    .qr-row:last-child {
      border-bottom: none;
    }

    .qr-row-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
      min-width: 44px;
    }

    .qr-row-inputs {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .qr-row-qr {
      flex-shrink: 0;
      width: 80px;
      height: 80px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fafbfc;
    }

    .qr-row-qr canvas {
      border-radius: 4px;
    }

    .qr-row-qr .placeholder {
      font-size: 11px;
      color: #bdc3c7;
    }

    /* Input Controls */
    .input-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-group label {
      font-size: 12px;
      color: var(--text-light);
      white-space: nowrap;
    }

    .num-input-wrap {
      display: flex;
      align-items: center;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .num-input-wrap button {
      width: 28px;
      height: 32px;
      border: none;
      background: #f0f3f6;
      cursor: pointer;
      font-size: 14px;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    .num-input-wrap button:hover {
      background: #e0e5ea;
    }

    .num-input-wrap input {
      width: 48px;
      text-align: center;
      border: none;
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      padding: 6px 4px;
      font-family: inherit;
      font-size: 13px;
      outline: none;
    }

    /* Button Grid for units */
    .btn-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .btn-grid .grid-btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text);
    }

    .btn-grid .grid-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-grid .grid-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: var(--radius);
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      width: 360px;
      max-width: 90vw;
      transform: translateY(20px);
      transition: transform 0.2s;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 15px;
      font-weight: 600;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-body input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      outline: none;
    }

    .modal-body input:focus {
      border-color: var(--primary);
    }

    .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #2c3e50;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 200;
      transition: transform 0.3s;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* Badge */
    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--primary);
      color: white;
      font-weight: 500;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 30px;
      color: var(--text-light);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main {
        grid-template-columns: 1fr;
        padding: 12px;
      }

      .student-panel {
        position: static;
        max-height: 300px;
      }
    }

    /* Select count bar */
    .select-bar {
      padding: 10px 16px;
      background: rgba(119, 136, 153, 0.06);
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <div>
      <h1>ğŸ“± QR ì½”ë“œ ìƒì„±ê¸°</h1>
      <div class="subtitle">ê³ ìƒ˜ì˜ì–´ í•™ì›</div>
    </div>
    <div class="header-right">
      <input type="date" class="date-picker" id="workDate">
      <button class="btn btn-sm btn-success" onclick="saveAllRecords()" style="font-weight:600;">ğŸ’¾ ì €ì¥</button>
      <button class="btn btn-sm" style="background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3);" onclick="openHistory()">ğŸ“‹ ê¸°ë¡</button>
      <button class="btn btn-sm" style="background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3);" onclick="printSelected()">ğŸ–¨ ì¸ì‡„</button>
      <button class="btn btn-sm" style="background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3);" onclick="openSettings()">âš™ ê´€ë¦¬</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Left: Student List -->
    <div class="card student-panel">
      <div class="card-header">
        <h2>ğŸ‘¨â€ğŸ“ í•™ìƒ ëª©ë¡</h2>
        <span class="badge" id="studentCount">0ëª…</span>
      </div>
      <div class="student-add-row">
        <input type="text" id="newStudentName" placeholder="í•™ìƒ ì´ë¦„ ì…ë ¥" maxlength="20"
               onkeypress="if(event.key==='Enter')addStudent()">
        <button class="btn btn-primary btn-sm" onclick="addStudent()">ì¶”ê°€</button>
      </div>
      <div class="student-list" id="studentList">
        <div class="loading">
          <div class="spinner"></div>
          ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
      </div>
      <div class="select-bar">
        <span id="selectInfo">0ëª… ì„ íƒë¨</span>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-sm btn-outline" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
          <button class="btn btn-sm btn-outline" onclick="clearSelection()">ì„ íƒ í•´ì œ</button>
        </div>
      </div>
    </div>

    <!-- Right: Work Area -->
    <div class="work-area" id="workArea">
      <div class="card">
        <div class="card-body">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <p>ì™¼ìª½ì—ì„œ í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header" id="editModalTitle">í•™ìƒ ì´ë¦„ ìˆ˜ì •</div>
      <div class="modal-body">
        <input type="text" id="editInput" maxlength="20" onkeypress="if(event.key==='Enter')confirmEdit()">
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('editModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="confirmEdit()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal" style="width:420px;">
      <div class="modal-header">âš™ êµì¬ ê´€ë¦¬</div>
      <div class="modal-body" id="settingsBody">
        <div style="margin-bottom:16px;">
          <div style="font-size:13px;font-weight:600;margin-bottom:8px;">êµì¬ ëª©ë¡</div>
          <div id="textbookList"></div>
          <div style="display:flex;gap:8px;margin-top:10px;">
            <input type="text" id="newTextbook" placeholder="ìƒˆ êµì¬ëª…" style="flex:1;">
            <button class="btn btn-primary btn-sm" onclick="addTextbook()">ì¶”ê°€</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeModal('settingsModal')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal-overlay" id="historyModal">
    <div class="modal" style="width:600px;max-height:80vh;display:flex;flex-direction:column;">
      <div class="modal-header" style="display:flex;align-items:center;justify-content:space-between;">
        <span>ğŸ“‹ QR ê¸°ë¡ ì¡°íšŒ</span>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="date" id="historyFrom" class="date-picker" style="background:#f0f3f6;color:var(--text);border:1px solid var(--border);font-size:12px;padding:4px 8px;">
          <span style="font-size:12px;color:var(--text-light);">~</span>
          <input type="date" id="historyTo" class="date-picker" style="background:#f0f3f6;color:var(--text);border:1px solid var(--border);font-size:12px;padding:4px 8px;">
          <button class="btn btn-primary btn-sm" onclick="searchHistory()">ì¡°íšŒ</button>
        </div>
      </div>
      <div class="modal-body" id="historyBody" style="flex:1;overflow-y:auto;padding:12px 20px;">
        <div style="text-align:center;padding:30px;color:var(--text-light);font-size:13px;">
          ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  ì¡°íšŒí•´ì£¼ì„¸ìš”
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('historyModal')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Print Styles -->
  <style>
    @media print {
      body { background: white; }
      .header, .student-panel, .select-bar, .modal-overlay, .toast { display: none !important; }
      .main {
        display: block !important;
        max-width: 100% !important;
        padding: 0 !important;
      }
      .student-work-card {
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #ccc !important;
        margin-bottom: 16px !important;
      }
      .qr-row { padding: 10px 14px !important; }
      .qr-row-qr { border: none !important; background: none !important; }
      .btn-grid .grid-btn:not(.active) { display: none !important; }
      .btn-grid .grid-btn.active {
        background: #f0f3f6 !important;
        color: #333 !important;
        border-color: #999 !important;
      }
      .num-input-wrap button { display: none !important; }
      .num-input-wrap { border: none !important; }
      .num-input-wrap input { border: none !important; font-weight: 600; }
      .student-actions, .icon-btn { display: none !important; }
    }
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc, query, orderBy, where, onSnapshot, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyC5M014PkaOMBGHrWVQP6Q_wb6zOb7I0qs",
      authDomain: "gosuchatapp.firebaseapp.com",
      projectId: "gosuchatapp",
      storageBucket: "gosuchatapp.firebasestorage.app",
      messagingSenderId: "629416132349",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app, 'gosuapp251015');

    // Constants
    const ACADEMY_ID = 'zIoVXK5mAkhzJQX2OZt4fpVwne93';
    const STUDENTS_COL = `academies/${ACADEMY_ID}/qrStudents`;
    const TEXTBOOKS_COL = `academies/${ACADEMY_ID}/qrTextbooks`;
    const RECORDS_COL = `academies/${ACADEMY_ID}/qrRecords`;

    // State
    let students = [];
    let selectedStudents = new Set();
    let textbooks = [];
    let editingStudentId = null;

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      // Set today's date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('workDate').value = today;

      // Date change handler
      document.getElementById('workDate').addEventListener('change', () => {
        loadRecordsForDate();
      });

      // Load data
      loadStudents();
      loadTextbooks();
    });

    // ==================== RECORDS LOADING ====================

    let loadedRecords = {}; // { studentId: { textbook: {...} } }

    async function loadRecordsForDate() {
      const date = document.getElementById('workDate').value;
      if (!date) return;

      loadedRecords = {};

      try {
        const q = query(
          collection(db, RECORDS_COL),
          where('date', '==', date)
        );
        const snapshot = await getDocs(q);
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          loadedRecords[data.studentId] = {};
          if (data.records) {
            data.records.forEach(r => {
              loadedRecords[data.studentId][r.textbook] = r;
            });
          }
        });

        // Re-render if students are selected
        if (selectedStudents.size > 0) {
          renderWorkArea();
          // After render, restore values from loaded records
          setTimeout(() => restoreRecordValues(), 100);
        }
      } catch (e) {
        console.error('ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', e);
      }
    }

    function restoreRecordValues() {
      for (const studentId of selectedStudents) {
        const recs = loadedRecords[studentId];
        if (!recs) continue;

        for (const tb of textbooks) {
          const record = recs[tb.name];
          if (!record || !record.url) continue;

          const prefix = `${studentId}-${tb.id}`;

          try {
            const url = new URL(record.url);
            const pages = url.searchParams.get('pages') || '';
            const unit = url.searchParams.get('unit') || '';

            if (tb.name === 'ë¬¸ë²•') {
              const parts = pages.split('-');
              const startEl = document.getElementById(`start-${prefix}`);
              const endEl = document.getElementById(`end-${prefix}`);
              if (startEl && parts[0]) startEl.value = parts[0];
              if (endEl && parts[1]) endEl.value = parts[1];
            } else if (tb.name === 'ë…í•´') {
              const unitNum = unit.replace('ë‹¨ì›', '');
              const btns = document.querySelectorAll(`#unit-grid-${prefix} .grid-btn`);
              btns.forEach(b => {
                b.classList.toggle('active', b.dataset.value === unitNum);
              });
              const pageEl = document.getElementById(`page-${prefix}`);
              if (pageEl) pageEl.value = pages;
            } else if (tb.name === 'í´ì¹´') {
              const dayNum = unit.replace('day', '');
              const btns = document.querySelectorAll(`#day-grid-${prefix} .grid-btn`);
              btns.forEach(b => {
                b.classList.toggle('active', b.dataset.value === dayNum);
              });
              const pageEl = document.getElementById(`cpage-${prefix}`);
              if (pageEl) pageEl.value = pages;
            } else {
              const pageEl = document.getElementById(`custom-${prefix}`);
              if (pageEl) pageEl.value = pages;
            }

            // Generate QR for restored values
            generateQR(studentId, tb.id);
          } catch (e) {
            console.error('ë³µì› ì˜¤ë¥˜:', e);
          }
        }
      }
    }

    // ==================== STUDENTS ====================

    function loadStudents() {
      const col = collection(db, STUDENTS_COL);
      const q = query(col, orderBy('name'));

      onSnapshot(q, (snapshot) => {
        students = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderStudentList();
      }, (error) => {
        console.error('í•™ìƒ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('studentList').innerHTML =
          '<div class="loading" style="color:var(--danger)">ë¡œë“œ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</div>';
      });
    }

    function renderStudentList() {
      const container = document.getElementById('studentList');
      document.getElementById('studentCount').textContent = `${students.length}ëª…`;

      if (students.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-light);font-size:13px;">í•™ìƒì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>';
        return;
      }

      container.innerHTML = students.map(s => `
        <div class="student-item ${selectedStudents.has(s.id) ? 'selected' : ''}"
             onclick="toggleStudent('${s.id}')">
          <div class="student-checkbox">
            <svg viewBox="0 0 12 12"><polyline points="2,6 5,9 10,3"/></svg>
          </div>
          <span class="student-name">${escapeHtml(s.name)}</span>
          <div class="student-actions" onclick="event.stopPropagation()">
            <button class="icon-btn" onclick="editStudent('${s.id}','${escapeHtml(s.name)}')" title="ìˆ˜ì •">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
            <button class="icon-btn danger" onclick="deleteStudent('${s.id}','${escapeHtml(s.name)}')" title="ì‚­ì œ">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
              </svg>
            </button>
          </div>
        </div>
      `).join('');

      updateSelectInfo();
    }

    window.addStudent = async function() {
      const input = document.getElementById('newStudentName');
      const name = input.value.trim();
      if (!name) return showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');

      // ì¤‘ë³µ ì²´í¬
      if (students.some(s => s.name === name)) {
        return showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤');
      }

      try {
        await addDoc(collection(db, STUDENTS_COL), {
          name: name,
          createdAt: Timestamp.now()
        });
        input.value = '';
        showToast(`${name} ì¶”ê°€ ì™„ë£Œ`);
      } catch (e) {
        console.error(e);
        showToast('ì¶”ê°€ ì‹¤íŒ¨');
      }
    };

    window.editStudent = function(id, name) {
      editingStudentId = id;
      document.getElementById('editModalTitle').textContent = 'í•™ìƒ ì´ë¦„ ìˆ˜ì •';
      document.getElementById('editInput').value = name;
      openModal('editModal');
      setTimeout(() => document.getElementById('editInput').select(), 100);
    };

    window.confirmEdit = async function() {
      const newName = document.getElementById('editInput').value.trim();
      if (!newName) return showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      if (!editingStudentId) return;

      try {
        await updateDoc(doc(db, STUDENTS_COL, editingStudentId), { name: newName });
        closeModal('editModal');
        showToast('ìˆ˜ì • ì™„ë£Œ');
        editingStudentId = null;
      } catch (e) {
        console.error(e);
        showToast('ìˆ˜ì • ì‹¤íŒ¨');
      }
    };

    window.deleteStudent = async function(id, name) {
      if (!confirm(`"${name}" í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        await deleteDoc(doc(db, STUDENTS_COL, id));
        selectedStudents.delete(id);
        renderWorkArea();
        showToast(`${name} ì‚­ì œ ì™„ë£Œ`);
      } catch (e) {
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    };

    window.toggleStudent = function(id) {
      if (selectedStudents.has(id)) {
        selectedStudents.delete(id);
      } else {
        selectedStudents.add(id);
      }
      renderStudentList();
      renderWorkArea();
    };

    window.clearSelection = function() {
      selectedStudents.clear();
      renderStudentList();
      renderWorkArea();
    };

    function updateSelectInfo() {
      document.getElementById('selectInfo').textContent = `${selectedStudents.size}ëª… ì„ íƒë¨`;
    }

    // ==================== TEXTBOOKS ====================

    function loadTextbooks() {
      const col = collection(db, TEXTBOOKS_COL);

      onSnapshot(col, (snapshot) => {
        textbooks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        if (textbooks.length === 0) {
          // ê¸°ë³¸ êµì¬ ìƒì„±
          initDefaultTextbooks();
        }
        renderWorkArea();
      });
    }

    async function initDefaultTextbooks() {
      const defaults = [
        { name: 'ë¬¸ë²•', type: 'grammar', order: 1 },
        { name: 'ë…í•´', type: 'reading', order: 2 },
        { name: 'í´ì¹´', type: 'card', order: 3 },
      ];
      for (const tb of defaults) {
        await addDoc(collection(db, TEXTBOOKS_COL), { ...tb, createdAt: Timestamp.now() });
      }
    }

    window.addTextbook = async function() {
      const input = document.getElementById('newTextbook');
      const name = input.value.trim();
      if (!name) return;

      try {
        await addDoc(collection(db, TEXTBOOKS_COL), {
          name,
          type: 'custom',
          order: textbooks.length + 1,
          createdAt: Timestamp.now()
        });
        input.value = '';
        showToast(`êµì¬ "${name}" ì¶”ê°€ ì™„ë£Œ`);
      } catch (e) {
        showToast('ì¶”ê°€ ì‹¤íŒ¨');
      }
    };

    window.deleteTextbook = async function(id, name) {
      if (!confirm(`"${name}" êµì¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      try {
        await deleteDoc(doc(db, TEXTBOOKS_COL, id));
        showToast('ì‚­ì œ ì™„ë£Œ');
      } catch (e) {
        showToast('ì‚­ì œ ì‹¤íŒ¨');
      }
    };

    window.openSettings = function() {
      renderTextbookSettings();
      openModal('settingsModal');
    };

    function renderTextbookSettings() {
      const container = document.getElementById('textbookList');
      container.innerHTML = textbooks.map(tb => `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid var(--border);border-radius:6px;margin-bottom:6px;">
          <span style="font-size:14px;">${escapeHtml(tb.name)}</span>
          <button class="icon-btn danger" onclick="deleteTextbook('${tb.id}','${escapeHtml(tb.name)}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
          </button>
        </div>
      `).join('');
    }

    // ==================== WORK AREA ====================

    function renderWorkArea() {
      const container = document.getElementById('workArea');

      if (selectedStudents.size === 0) {
        container.innerHTML = `
          <div class="card"><div class="card-body">
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              <p>ì™¼ìª½ì—ì„œ í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</p>
            </div>
          </div></div>`;
        return;
      }

      const selectedList = students.filter(s => selectedStudents.has(s.id));

      // ì¼ê´„ ì ìš© íŒ¨ë„ (2ëª… ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ)
      let batchHtml = '';
      if (selectedList.length >= 2) {
        batchHtml = `
          <div class="card" style="border-left:3px solid var(--warning);">
            <div class="card-header" style="background:#fffbf0;">
              <h2 style="font-size:13px;">âš¡ ì¼ê´„ ì ìš© <span style="font-weight:400;color:var(--text-light);">â€” ì„ íƒëœ ${selectedList.length}ëª…ì—ê²Œ ë™ì¼í•œ ê°’ ì ìš©</span></h2>
            </div>
            <div class="card-body" style="padding:12px 18px;">
              ${textbooks.sort((a,b) => a.order - b.order).map(tb => `
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;padding:8px 0;${tb !== textbooks[textbooks.length-1] ? 'border-bottom:1px solid #f0f2f4;' : ''}">
                  <span style="font-size:13px;font-weight:600;color:var(--primary);min-width:44px;">${escapeHtml(tb.name)}</span>
                  <div style="flex:1;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    ${getBatchInputs(tb)}
                  </div>
                  <button class="btn btn-sm" style="background:var(--warning);color:white;white-space:nowrap;" onclick="applyBatch('${tb.id}','${tb.name}')">ì ìš©</button>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      container.innerHTML = batchHtml + selectedList.map(student => {
        const hasRecord = !!loadedRecords[student.id];
        return `
        <div class="student-work-card">
          <div class="student-work-header">
            <h3>ğŸ“‹ ${escapeHtml(student.name)} ${hasRecord ? '<span style="font-size:11px;color:var(--success);margin-left:6px;">â— ê¸°ë¡ìˆìŒ</span>' : ''}</h3>
            <span style="font-size:12px;color:var(--text-light);">${textbooks.length}ê°œ QRì½”ë“œ</span>
          </div>
          ${textbooks.sort((a,b) => a.order - b.order).map(tb => `
            <div class="qr-row">
              <div class="qr-row-label">${escapeHtml(tb.name)}</div>
              <div class="qr-row-inputs">
                ${getInputsForTextbook(tb, student.id)}
              </div>
              <div class="qr-row-qr" id="qr-${student.id}-${tb.id}">
                <span class="placeholder">QR</span>
              </div>
            </div>
          `).join('')}
        </div>
      `}).join('');
    }

    function getInputsForTextbook(tb, studentId) {
      const prefix = `${studentId}-${tb.id}`;

      if (tb.name === 'ë¬¸ë²•') {
        return `
          <div class="input-group">
            <label>ì‹œì‘</label>
            <div class="num-input-wrap">
              <button onclick="adjustNum('start-${prefix}',-1)">âˆ’</button>
              <input type="number" id="start-${prefix}" min="1" max="300" value="1" onchange="onInputChange('${studentId}','${tb.id}')">
              <button onclick="adjustNum('start-${prefix}',1)">+</button>
            </div>
          </div>
          <span style="color:var(--text-light);">~</span>
          <div class="input-group">
            <label>ë</label>
            <div class="num-input-wrap">
              <button onclick="adjustNum('end-${prefix}',-1)">âˆ’</button>
              <input type="number" id="end-${prefix}" min="1" max="300" value="1" onchange="onInputChange('${studentId}','${tb.id}')">
              <button onclick="adjustNum('end-${prefix}',1)">+</button>
            </div>
          </div>
        `;
      }

      if (tb.name === 'ë…í•´') {
        return `
          <div class="input-group">
            <label>ë‹¨ì›</label>
            <div class="btn-grid" id="unit-grid-${prefix}">
              ${Array.from({length:10}, (_,i) => `
                <button class="grid-btn" onclick="selectUnit(this,'${prefix}')" data-value="${i+1}">${i+1}ë‹¨ì›</button>
              `).join('')}
            </div>
          </div>
          <div class="input-group" style="margin-left:6px;">
            <label>p.</label>
            <div class="num-input-wrap">
              <button onclick="adjustNum('page-${prefix}',-1)">âˆ’</button>
              <input type="number" id="page-${prefix}" min="1" max="300" value="1" onchange="onInputChange('${studentId}','${tb.id}')">
              <button onclick="adjustNum('page-${prefix}',1)">+</button>
            </div>
          </div>
        `;
      }

      if (tb.name === 'í´ì¹´') {
        return `
          <div class="input-group" style="flex-direction:column;align-items:flex-start;gap:6px;">
            <label>Day ì„ íƒ</label>
            <div class="btn-grid" id="day-grid-${prefix}">
              ${Array.from({length:30}, (_,i) => `
                <button class="grid-btn" onclick="selectDay(this,'${prefix}')" data-value="${i+1}" style="min-width:48px;">Day${i+1}</button>
              `).join('')}
            </div>
          </div>
          <div class="input-group">
            <label>p.</label>
            <div class="num-input-wrap">
              <button onclick="adjustNum('cpage-${prefix}',-1)">âˆ’</button>
              <input type="number" id="cpage-${prefix}" min="1" max="300" value="1" onchange="onInputChange('${studentId}','${tb.id}')">
              <button onclick="adjustNum('cpage-${prefix}',1)">+</button>
            </div>
          </div>
        `;
      }

      // Custom textbook - simple page input
      return `
        <div class="input-group">
          <label>p.</label>
          <div class="num-input-wrap">
            <button onclick="adjustNum('custom-${prefix}',-1)">âˆ’</button>
            <input type="number" id="custom-${prefix}" min="1" max="300" value="1" onchange="onInputChange('${studentId}','${tb.id}')">
            <button onclick="adjustNum('custom-${prefix}',1)">+</button>
          </div>
        </div>
      `;
    }

    function getBatchInputs(tb) {
      const prefix = `batch-${tb.id}`;

      if (tb.name === 'ë¬¸ë²•') {
        return `
          <div class="input-group">
            <label>ì‹œì‘</label>
            <div class="num-input-wrap">
              <button onclick="adjustBatchNum('bstart-${tb.id}',-1)">âˆ’</button>
              <input type="number" id="bstart-${tb.id}" min="1" max="300" value="1">
              <button onclick="adjustBatchNum('bstart-${tb.id}',1)">+</button>
            </div>
          </div>
          <span style="color:var(--text-light);">~</span>
          <div class="input-group">
            <label>ë</label>
            <div class="num-input-wrap">
              <button onclick="adjustBatchNum('bend-${tb.id}',-1)">âˆ’</button>
              <input type="number" id="bend-${tb.id}" min="1" max="300" value="1">
              <button onclick="adjustBatchNum('bend-${tb.id}',1)">+</button>
            </div>
          </div>
        `;
      }

      if (tb.name === 'ë…í•´') {
        return `
          <div class="input-group">
            <label>ë‹¨ì›</label>
            <select id="bunit-${tb.id}" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:12px;">
              ${Array.from({length:10}, (_,i) => `<option value="${i+1}">${i+1}ë‹¨ì›</option>`).join('')}
            </select>
          </div>
          <div class="input-group">
            <label>p.</label>
            <div class="num-input-wrap">
              <button onclick="adjustBatchNum('bpage-${tb.id}',-1)">âˆ’</button>
              <input type="number" id="bpage-${tb.id}" min="1" max="300" value="1">
              <button onclick="adjustBatchNum('bpage-${tb.id}',1)">+</button>
            </div>
          </div>
        `;
      }

      if (tb.name === 'í´ì¹´') {
        return `
          <div class="input-group">
            <label>Day</label>
            <select id="bday-${tb.id}" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:12px;">
              ${Array.from({length:30}, (_,i) => `<option value="${i+1}">Day${i+1}</option>`).join('')}
            </select>
          </div>
          <div class="input-group">
            <label>p.</label>
            <div class="num-input-wrap">
              <button onclick="adjustBatchNum('bcpage-${tb.id}',-1)">âˆ’</button>
              <input type="number" id="bcpage-${tb.id}" min="1" max="300" value="1">
              <button onclick="adjustBatchNum('bcpage-${tb.id}',1)">+</button>
            </div>
          </div>
        `;
      }

      return `
        <div class="input-group">
          <label>p.</label>
          <div class="num-input-wrap">
            <button onclick="adjustBatchNum('bcustom-${tb.id}',-1)">âˆ’</button>
            <input type="number" id="bcustom-${tb.id}" min="1" max="300" value="1">
            <button onclick="adjustBatchNum('bcustom-${tb.id}',1)">+</button>
          </div>
        </div>
      `;
    }

    window.adjustBatchNum = function(inputId, delta) {
      const input = document.getElementById(inputId);
      if (!input) return;
      let val = parseInt(input.value) || 1;
      val = Math.max(1, Math.min(300, val + delta));
      input.value = val;
    };

    window.applyBatch = function(tbId, tbName) {
      const selectedList = students.filter(s => selectedStudents.has(s.id));
      if (selectedList.length === 0) return;

      for (const student of selectedList) {
        const prefix = `${student.id}-${tbId}`;

        if (tbName === 'ë¬¸ë²•') {
          const bStart = document.getElementById(`bstart-${tbId}`);
          const bEnd = document.getElementById(`bend-${tbId}`);
          const sStart = document.getElementById(`start-${prefix}`);
          const sEnd = document.getElementById(`end-${prefix}`);
          if (bStart && sStart) sStart.value = bStart.value;
          if (bEnd && sEnd) sEnd.value = bEnd.value;
        } else if (tbName === 'ë…í•´') {
          const bUnit = document.getElementById(`bunit-${tbId}`);
          const bPage = document.getElementById(`bpage-${tbId}`);
          if (bUnit) {
            const btns = document.querySelectorAll(`#unit-grid-${prefix} .grid-btn`);
            btns.forEach(b => b.classList.toggle('active', b.dataset.value === bUnit.value));
          }
          const sPage = document.getElementById(`page-${prefix}`);
          if (bPage && sPage) sPage.value = bPage.value;
        } else if (tbName === 'í´ì¹´') {
          const bDay = document.getElementById(`bday-${tbId}`);
          const bPage = document.getElementById(`bcpage-${tbId}`);
          if (bDay) {
            const btns = document.querySelectorAll(`#day-grid-${prefix} .grid-btn`);
            btns.forEach(b => b.classList.toggle('active', b.dataset.value === bDay.value));
          }
          const sPage = document.getElementById(`cpage-${prefix}`);
          if (bPage && sPage) sPage.value = bPage.value;
        } else {
          const bCustom = document.getElementById(`bcustom-${tbId}`);
          const sCustom = document.getElementById(`custom-${prefix}`);
          if (bCustom && sCustom) sCustom.value = bCustom.value;
        }

        generateQR(student.id, tbId);
      }

      showToast(`${tbName} ê°’ì„ ${selectedList.length}ëª…ì—ê²Œ ì¼ê´„ ì ìš© âœ“`);
    };

    // ==================== INPUT HANDLERS ====================

    window.adjustNum = function(inputId, delta) {
      const input = document.getElementById(inputId);
      if (!input) return;
      let val = parseInt(input.value) || 1;
      val = Math.max(1, Math.min(300, val + delta));
      input.value = val;

      // Extract studentId and tbId from inputId
      // Format: "start-STUDENTID-TBID" or "end-STUDENTID-TBID" etc.
      const dashIdx = inputId.indexOf('-');
      if (dashIdx === -1) return;
      const rest = inputId.substring(dashIdx + 1);
      const lastDash = rest.lastIndexOf('-');
      if (lastDash === -1) return;
      const studentId = rest.substring(0, lastDash);
      const tbId = rest.substring(lastDash + 1);
      generateQR(studentId, tbId);
    };

    window.selectUnit = function(btn, prefix) {
      const grid = btn.closest('.btn-grid');
      grid.querySelectorAll('.grid-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const lastDash = prefix.lastIndexOf('-');
      generateQR(prefix.substring(0, lastDash), prefix.substring(lastDash + 1));
    };

    window.selectDay = function(btn, prefix) {
      const grid = btn.closest('.btn-grid');
      grid.querySelectorAll('.grid-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const lastDash = prefix.lastIndexOf('-');
      generateQR(prefix.substring(0, lastDash), prefix.substring(lastDash + 1));
    };

    window.onInputChange = function(studentId, tbId) {
      generateQR(studentId, tbId);
    };

    // ==================== QR CODE GENERATION ====================

    function getQRData(studentId, tbId) {
      const student = students.find(s => s.id === studentId);
      const tb = textbooks.find(t => t.id === tbId);
      if (!student || !tb) return null;

      const prefix = `${studentId}-${tbId}`;
      const studentName = student.name;

      if (tb.name === 'ë¬¸ë²•') {
        const startEl = document.getElementById(`start-${prefix}`);
        const endEl = document.getElementById(`end-${prefix}`);
        const startPage = startEl ? startEl.value : '1';
        const endPage = endEl ? endEl.value : '1';
        const url = `gosuapp://scan?subject=ë¬¸ë²•&pages=${startPage}-${endPage}&studentName=${encodeURIComponent(studentName)}`;
        return { url, display: `ë¬¸ë²• p.${startPage}~${endPage}` };
      }

      if (tb.name === 'ë…í•´') {
        const activeUnit = document.querySelector(`#unit-grid-${prefix} .grid-btn.active`);
        const unit = activeUnit ? activeUnit.dataset.value : '';
        const pageEl = document.getElementById(`page-${prefix}`);
        const page = pageEl ? pageEl.value : '1';
        if (!unit) return null;
        const url = `gosuapp://scan?subject=ë…í•´&unit=${unit}ë‹¨ì›&pages=${page}&studentName=${encodeURIComponent(studentName)}`;
        return { url, display: `ë…í•´ ${unit}ë‹¨ì› p.${page}` };
      }

      if (tb.name === 'í´ì¹´') {
        const activeDay = document.querySelector(`#day-grid-${prefix} .grid-btn.active`);
        const day = activeDay ? activeDay.dataset.value : '';
        const pageEl = document.getElementById(`cpage-${prefix}`);
        const page = pageEl ? pageEl.value : '1';
        if (!day) return null;
        const url = `gosuapp://scan?subject=í´ì¹´&unit=day${day}&pages=${page}&studentName=${encodeURIComponent(studentName)}`;
        return { url, display: `í´ì¹´ Day${day} p.${page}` };
      }

      // Custom
      const pageEl = document.getElementById(`custom-${prefix}`);
      const page = pageEl ? pageEl.value : '1';
      const url = `gosuapp://scan?subject=${encodeURIComponent(tb.name)}&pages=${page}&studentName=${encodeURIComponent(studentName)}`;
      return { url, display: `${tb.name} p.${page}` };
    }

    function generateQR(studentId, tbId) {
      const container = document.getElementById(`qr-${studentId}-${tbId}`);
      if (!container) return;

      const qrData = getQRData(studentId, tbId);
      if (!qrData) {
        container.innerHTML = '<span class="placeholder">í•­ëª© ì„ íƒ</span>';
        return;
      }

      // Clear previous
      container.innerHTML = '';

      try {
        new QRCode(container, {
          text: qrData.url,
          width: 72,
          height: 72,
          colorDark: '#778899',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.M,
        });
      } catch (e) {
        console.error('QR ìƒì„± ì˜¤ë¥˜:', e);
        container.innerHTML = '<span class="placeholder">ì˜¤ë¥˜</span>';
      }
    }

    // ==================== SAVE RECORDS ====================

    window.saveAllRecords = async function() {
      const date = document.getElementById('workDate').value;
      if (!date) return showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');

      const selectedList = students.filter(s => selectedStudents.has(s.id));
      if (selectedList.length === 0) return showToast('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”');

      let savedCount = 0;
      let errorCount = 0;

      for (const student of selectedList) {
        const records = [];
        for (const tb of textbooks) {
          const qrData = getQRData(student.id, tb.id);
          if (qrData) {
            records.push({
              textbook: tb.name,
              url: qrData.url,
              display: qrData.display,
            });
          }
        }

        if (records.length === 0) continue;

        try {
          const docId = `${date}_${student.id}`;
          await setDoc(doc(db, RECORDS_COL, docId), {
            studentId: student.id,
            studentName: student.name,
            date: date,
            records: records,
            createdAt: Timestamp.now(),
            updatedAt: Timestamp.now(),
          }, { merge: true });
          savedCount++;
        } catch (e) {
          console.error('ì €ì¥ ì˜¤ë¥˜:', e);
          errorCount++;
        }
      }

      if (errorCount > 0) {
        showToast(`${savedCount}ëª… ì €ì¥ ì™„ë£Œ, ${errorCount}ëª… ì‹¤íŒ¨`);
      } else {
        showToast(`${savedCount}ëª… QR ê¸°ë¡ ì €ì¥ ì™„ë£Œ âœ“`);
      }
    };

    // ==================== UTILITIES ====================

    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    window.closeModal = function(id) {
      document.getElementById(id).classList.remove('active');
    };

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ==================== SELECT ALL ====================

    window.selectAll = function() {
      if (selectedStudents.size === students.length) {
        // ì´ë¯¸ ì „ì²´ ì„ íƒì´ë©´ í•´ì œ
        selectedStudents.clear();
      } else {
        students.forEach(s => selectedStudents.add(s.id));
      }
      renderStudentList();
      renderWorkArea();
      // Restore saved records after render
      setTimeout(() => restoreRecordValues(), 150);
    };

    // ==================== HISTORY ====================

    window.openHistory = function() {
      // ê¸°ë³¸ ë²”ìœ„: ìµœê·¼ 7ì¼
      const today = new Date();
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);

      document.getElementById('historyTo').value = today.toISOString().split('T')[0];
      document.getElementById('historyFrom').value = weekAgo.toISOString().split('T')[0];

      openModal('historyModal');
      searchHistory();
    };

    window.searchHistory = async function() {
      const from = document.getElementById('historyFrom').value;
      const to = document.getElementById('historyTo').value;
      const body = document.getElementById('historyBody');

      if (!from || !to) {
        body.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-light);">ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>';
        return;
      }

      body.innerHTML = '<div class="loading"><div class="spinner"></div>ì¡°íšŒ ì¤‘...</div>';

      try {
        const q = query(
          collection(db, RECORDS_COL),
          where('date', '>=', from),
          where('date', '<=', to),
          orderBy('date', 'desc')
        );
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          body.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-light);">í•´ë‹¹ ê¸°ê°„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }

        // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í•‘
        const grouped = {};
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (!grouped[data.date]) grouped[data.date] = [];
          grouped[data.date].push(data);
        });

        let html = '';
        for (const [date, records] of Object.entries(grouped)) {
          const dateObj = new Date(date + 'T00:00:00');
          const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
          const dayName = dayNames[dateObj.getDay()];

          html += `
            <div style="margin-bottom:16px;">
              <div style="font-size:13px;font-weight:700;color:var(--primary-dark);margin-bottom:8px;padding-bottom:6px;border-bottom:2px solid var(--border);">
                ğŸ“… ${date} (${dayName}) â€” ${records.length}ëª…
              </div>
              <div style="display:flex;flex-direction:column;gap:6px;">
          `;

          for (const rec of records) {
            const items = (rec.records || []).map(r =>
              `<span style="display:inline-block;padding:2px 8px;background:#f0f3f6;border-radius:4px;font-size:11px;margin:2px;">${escapeHtml(r.display)}</span>`
            ).join('');

            html += `
              <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#fafbfc;border-radius:6px;border:1px solid #f0f2f4;">
                <span style="font-weight:600;font-size:13px;min-width:60px;">${escapeHtml(rec.studentName)}</span>
                <div style="flex:1;display:flex;flex-wrap:wrap;gap:2px;">${items}</div>
                <button class="btn btn-sm btn-outline" onclick="loadHistoryRecord('${date}','${rec.studentId}')" style="font-size:11px;white-space:nowrap;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
              </div>
            `;
          }

          html += '</div></div>';
        }

        body.innerHTML = html;
      } catch (e) {
        console.error('íˆìŠ¤í† ë¦¬ ì¡°íšŒ ì˜¤ë¥˜:', e);
        body.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger);">ì¡°íšŒ ì‹¤íŒ¨: ' + e.message + '</div>';
      }
    };

    window.loadHistoryRecord = function(date, studentId) {
      // ë‚ ì§œ ë³€ê²½ + í•´ë‹¹ í•™ìƒ ì„ íƒ + ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      document.getElementById('workDate').value = date;

      if (!selectedStudents.has(studentId)) {
        selectedStudents.add(studentId);
      }

      closeModal('historyModal');
      renderStudentList();
      renderWorkArea();

      // ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      loadRecordsForDate().then(() => {
        setTimeout(() => restoreRecordValues(), 150);
      });

      showToast('ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
    };

    // ==================== PRINT ====================

    window.printSelected = function() {
      if (selectedStudents.size === 0) {
        return showToast('ì¸ì‡„í•  í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”');
      }

      // ëª¨ë“  ì„ íƒëœ í•™ìƒì˜ QRì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
      const selectedList = students.filter(s => selectedStudents.has(s.id));
      let hasQR = false;
      for (const student of selectedList) {
        for (const tb of textbooks) {
          const container = document.getElementById(`qr-${student.id}-${tb.id}`);
          if (container && container.querySelector('canvas')) {
            hasQR = true;
            break;
          }
        }
        if (hasQR) break;
      }

      if (!hasQR) {
        return showToast('QRì½”ë“œê°€ ìƒì„±ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
      }

      window.print();
    };

    // Expose to window for inline handlers
    window.showToast = showToast;
  </script>

</body>
</html>
